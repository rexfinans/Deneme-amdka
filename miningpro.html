<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MiningPRO - VIP Kontrol</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
/* ========================================================================= */
/* --- GENEL STÄ°LLER VE TEMA --- */
/* ========================================================================= */
body, html {
  margin: 0; padding: 0;
  font-family: 'Poppins', sans-serif;
  background: #0D1117; 
  color: #E6EDF3; 
  min-height: 100vh;
  padding-bottom: 70px;
  line-height: 1.6;
}
.wrapper {
  max-width: 550px; 
  margin: 15px auto;
  padding: 0 15px;
}
header {
  background: #161B22;
  padding: 15px;
  text-align: center;
  font-size: 26px;
  font-weight: 800;
  color: #F3BA2F; 
  text-shadow: 0 0 10px rgba(243, 186, 47, 0.6); 
  box-shadow: 0 3px 15px rgba(0, 0, 0, 0.8);
  position: sticky;
  top: 0;
  z-index: 100;
  border-bottom: 1px solid #F3BA2F;
}
header i { margin-right: 10px; }

/* ========================================================================= */
/* --- KARTLAR VE BÄ°LGÄ° ALANLARI --- */
/* ========================================================================= */
.card {
  background: #161B22;
  border-radius: 16px; 
  padding: 25px;
  margin-bottom: 25px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6); 
  border: 1px solid #2D333B;
  transition: transform 0.3s ease;
}
.card h2 {
    color: #00BFFF; 
    font-size: 22px;
    margin-bottom: 15px;
    border-bottom: 2px solid #2D333B;
    padding-bottom: 10px;
    font-weight: 700;
}

/* --- KRÄ°PTO VE HIZ SEÃ‡Ä°MÄ° --- */
.select-group {
    margin-bottom: 20px;
    background: #2D333B;
    padding: 15px;
    border-radius: 12px;
}
.select-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #A0AEC0;
}
.select-group select, .select-group input {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #555;
    background: #0D1117;
    color: #E6EDF3;
    font-size: 16px;
    appearance: none; 
    -webkit-appearance: none;
    -moz-appearance: none;
}
.coin-select-wrapper {
    display: flex;
    align-items: center;
}
.coin-select-wrapper i {
    font-size: 24px;
    margin-right: 10px;
    color: #F3BA2F;
    min-width: 25px; 
}

/* HÄ±z SeÃ§imi (Her bir hÄ±z satÄ±rÄ±) */
.speed-option {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px solid #161B22;
}
.speed-option:last-child {
    border-bottom: none;
}
.speed-details {
    flex-grow: 1;
}
.speed-details span {
    display: block;
}
.speed-name {
    font-weight: 700;
    color: #00BFFF;
}
.speed-duration {
    font-size: 12px;
    color: #999;
}
.speed-controls {
    display: flex;
    gap: 8px;
    align-items: center;
}
.speed-controls input {
    width: 130px;
    padding: 8px;
    font-size: 14px;
}
.speed-controls button {
    padding: 8px 15px;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.3s;
    font-size: 14px;
}
.btn-activate {
    background: #4cd964;
    color: #0D1117;
}
.btn-buy {
    background: #F3BA2F;
    color: #0D1117;
}
.btn-disabled {
    background: #555;
    color: #999;
    cursor: not-allowed;
}

/* ========================================================================= */
/* --- KAZIM ALANI (FAN VE SÃœRE) --- */
/* ========================================================================= */
.mining-area {
    text-align: center;
    margin: 20px 0;
}
.fan-container {
    position: relative;
    width: 100px;
    height: 100px;
    margin: 0 auto 20px;
    border: 4px solid #F3BA2F;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 0 15px rgba(243, 186, 47, 0.8);
}
.fan-blade {
    position: absolute;
    width: 100%;
    height: 100%;
    background: transparent;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}
.fan-blade i {
    color: #F3BA2F;
    font-size: 40px;
    position: absolute;
}
/* FAN DÃ–NME ANÄ°MASYONU */
@keyframes spin {
    to { transform: rotate(360deg); }
}
.fan-container.spinning .fan-blade {
    animation: spin 0.8s linear infinite;
}
/* SÃ¼re ve Hashrate */
#miningTimer {
    font-size: 28px;
    font-weight: 700;
    color: #FF0057; 
}
.hashrate-info {
    font-size: 16px;
    color: #4cd964;
    font-weight: 600;
    margin-top: 10px;
}
#currentHashrate {
    font-size: 32px;
    font-weight: 800;
    display: block;
    color: #4cd964;
}

/* --- BAÅLAT/DURDUR BUTONU --- */
#toggleMiningBtn {
    padding: 18px 30px;
    border: none;
    border-radius: 50px;
    font-weight: 800;
    font-size: 20px;
    color: #0D1117;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 25px;
    min-width: 250px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}
.mining-off { background: #4CD964; box-shadow: 0 0 20px rgba(76, 217, 100, 0.7); }
.mining-on { background: #FF0057; box-shadow: 0 0 20px rgba(255, 0, 87, 0.7); }

/* --- BAKIYE KARTI --- */
.balance-display {
    text-align: center;
    padding: 15px;
    border-radius: 12px;
    margin-bottom: 20px;
    background: #0D1117;
    border: 1px solid #00BFFF;
}
#miningBalance {
    font-size: 36px;
    font-weight: 800;
    color: #00BFFF;
    text-shadow: 0 0 15px rgba(0, 191, 255, 0.8);
}
#transferBtn {
    margin-top: 15px;
    background: #F3BA2F;
    color: #0D1117;
    padding: 12px 20px;
    width: 100%;
}
#transferBtn:disabled {
    background: #2D333B;
    color: #777;
    cursor: not-allowed;
}

/* UyarÄ± Sistemi Korundu */
#floatingAlert {
    position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px);
    z-index: 10000; padding: 15px 25px; border-radius: 10px; font-weight: 700; color: #121212;
    box-shadow: 0 5px 20px rgba(0,0,0,0.4); transition: opacity 0.4s, transform 0.4s;
    opacity: 0; pointer-events: none; max-width: 90%; text-align: center;
}
#floatingAlert.show { opacity: 1; transform: translateX(-50%) translateY(0); }
.alert-success { background: #4cd964; }
.alert-error { background: #ff0057; }
.alert-info { background: #00bfff; }
</style>
</head>
<body>

<div id="floatingAlert" class="alert-info"></div>
<header><i class="fas fa-hammer"></i> MiningPRO KONTROL PANELÄ°</header>
<div class="wrapper">

    <div class="card">
        <h2>ğŸ› ï¸ KazÄ±m AyarlarÄ±</h2>
        
        <div class="select-group">
            <label for="coinSelect">KazÄ±m YapÄ±lacak Kripto:</label>
            <div class="coin-select-wrapper">
                <i class="fab fa-bitcoin" id="coinIcon"></i>
                <select id="coinSelect" onchange="window.updateCoinSelection()">
                    </select>
            </div>
        </div>

        <div class="select-group">
            <label>YÃ¼kseltme HÄ±zlarÄ± ve Aktivasyon:</label>
            <div id="speedOptionsContainer">
                </div>
        </div>
    </div>

    <div class="card">
        <h2>ğŸ’° KazÄ±m Bakiyesi</h2>
        <div class="balance-display">
            <div class="label">Åu Ana Kadar KazdÄ±ÄŸÄ±nÄ±z Miktar:</div>
            <div id="miningBalance">0.000000 <span>USDT</span></div>
            <div id="speedMultiplier" style="font-size: 16px; margin-top: 8px;">Aktif HÄ±z: 3x</div>
            <button id="transferBtn" onclick="window.transferMiningBalance()" disabled>
                <i class="fas fa-exchange-alt"></i> CÃœZDANA AKTAR (Manuel)
            </button>
            <div id="lastTransferInfo" style="font-size: 12px; color: #A0AEC0; margin-top: 8px;">12 Saatlik dÃ¶ngÃ¼ kontrol ediliyor...</div>
        </div>
    </div>

    <div class="card">
        <h2>âš¡ CanlÄ± Madencilik Durumu</h2>
        
        <div class="mining-area">
            <div class="fan-container" id="fanContainer">
                <div class="fan-blade">
                    <i class="fas fa-fan"></i>
                </div>
            </div>
            
            <div id="miningTimer">00:00:00</div>
            <div class="hashrate-info">
                AnlÄ±k Hashrate: 
                <span id="currentHashrate">0.00 MH/s</span>
            </div>
            
            <button id="toggleMiningBtn" class="mining-off" onclick="window.toggleMining()">
                <i class="fas fa-play"></i> LONG KAZIMI BAÅLAT
            </button>
        </div>
    </div>
    
</div>

<div class="bottom-menu">
  <a href="miningpro.html" id="tabMining" class="active"><i class="fas fa-tachometer-alt"></i> KazÄ±m</a>
  <a href="hizal.html" id="tabHizAl"><i class="fas fa-bolt"></i> HÄ±z Al</a>
  <a href="kazan.html" id="tabKazan"><i class="fas fa-trophy"></i> Kazan</a>
  <a href="cÃ¼zdanÄ±m.html" id="tabWallet"><i class="fas fa-wallet"></i> CÃ¼zdanÄ±m</a>
</div>

<script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js"></script>

<script>
// =========================================================================
// --- FIREBASE ENTEGRASYONU VE GLOBAL DEÄÄ°ÅKENLER --- 
// =========================================================================

// LÃœTFEN KENDÄ° FIREBASE AYARLARINIZLA DEÄÄ°ÅTÄ°RÄ°N
const firebaseConfig = {
  apiKey: "AIzaSyBwpgITzHh2K3oYTRDaNbGVexPR8IcqXBU",
  authDomain: "coinbase-a1aca.firebaseapp.com",
  projectId: "coinbase-a1aca",
  storageBucket: "coinbase-a1aca.firebasestorage.app",
  messagingSenderId: "596259885244",
  appId: "1:596259885244:web:186df79a6ccdc96f0d00b9",
  measurementId: "G-Q4SMPE62HF"
};

const app = firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const docRef = firebase.firestore.doc;
const getDoc = firebase.firestore.getDoc;
const setDoc = firebase.firestore.setDoc;
const updateDoc = firebase.firestore.updateDoc;
const onAuthStateChanged = firebase.auth.onAuthStateChanged;

let currentUserID = null;
let miningInterval; // Madencilik dÃ¶ngÃ¼sÃ¼
let timerInterval;  // SÃ¼re sayacÄ± dÃ¶ngÃ¼sÃ¼
const TWELVE_HOURS = 12 * 60 * 60 * 1000; // 12 saat milisaniye

// =========================================================================
// --- YAPILANDIRMA VE SABÄ°T DEÄERLER ---
// =========================================================================

// ADMIN PANELÄ°NDEN GELEN AKTÄ°VASYON KEYLERÄ° (Her key belirli bir hÄ±zÄ± aÃ§ar)
const ACTIVATION_KEYS = {
    "KEY-07X-10D": { speed: 7, duration: 10 * 24 * 60 * 60 * 1000 },
    "KEY-10X-20D": { speed: 10, duration: 20 * 24 * 60 * 60 * 1000 },
    "KEY-20X-30D": { speed: 20, duration: 30 * 24 * 60 * 60 * 1000 }
};

// HÄ±z Seviyeleri TanÄ±mlarÄ± (UnutmayÄ±n: 3x her zaman Ã¼cretsiz aÃ§Ä±ktÄ±r)
const SPEED_LEVELS = [
    { speed: 3, label: "3x (Temel)", durationDays: "SÃ¼resiz" },
    { speed: 7, label: "7x (10 GÃ¼nlÃ¼k)", durationDays: "10 GÃ¼n" },
    { speed: 10, label: "10x (20 GÃ¼nlÃ¼k)", durationDays: "20 GÃ¼n" },
    { speed: 20, label: "20x (30 GÃ¼nlÃ¼k)", durationDays: "30 GÃ¼n" }
];

// Kripto Para Listesi (12 Adet)
const CRYPTO_COINS = [
    { code: 'USDT', name: 'USDT (Tether)', icon: 'fas fa-dollar-sign' },
    { code: 'BTC', name: 'BTC (Bitcoin)', icon: 'fab fa-bitcoin' },
    { code: 'ETH', name: 'ETH (Ethereum)', icon: 'fab fa-ethereum' },
    { code: 'BNB', name: 'BNB (Binance)', icon: 'fas fa-hand-holding-usd' },
    { code: 'XRP', name: 'XRP (Ripple)', icon: 'fas fa-x-ray' },
    { code: 'ADA', name: 'ADA (Cardano)', icon: 'fab fa-adn' },
    { code: 'DOGE', name: 'DOGE (Dogecoin)', icon: 'fas fa-dog' },
    { code: 'SOL', name: 'SOL (Solana)', icon: 'fas fa-sun' },
    { code: 'DOT', name: 'DOT (Polkadot)', icon: 'fas fa-dot-circle' },
    { code: 'TRX', name: 'TRX (Tron)', icon: 'fas fa-bolt' },
    { code: 'LTC', name: 'LTC (Litecoin)', icon: 'fab fa-gripfire' },
    { code: 'SHIB', name: 'SHIB (Shiba)', icon: 'fas fa-paw' },
];

// GÃ¼nlÃ¼k KazanÃ§ OranlarÄ± (USDT cinsinden, 3x iÃ§in ortalama 0.75 USD)
function getDailyRate(speed) {
    return 0.75 + (speed - 3) * 0.20;
}
function calculateHashrate(speedMultiplier) {
    const BASE_HASHRATE = 0.12; 
    const RATE_PER_MULTIPLIER = 0.04; 
    return (BASE_HASHRATE + (speedMultiplier - 3) * RATE_PER_MULTIPLIER).toFixed(2);
}

// =========================================================================
// --- UI GÃœNCELLEME VE YARDIMCI FONKSÄ°YONLAR ---
// =========================================================================
// (Alert ve Ä°kon fonksiyonlarÄ± Ã¶nceki gibi)

let alertTimeout = null;
function showFloatingAlert(message, type = 'info', duration = 3000) {
    const alertEl = document.getElementById('floatingAlert');
    if (!alertEl) return;
    clearTimeout(alertTimeout);
    alertEl.className = '';
    alertEl.classList.add(`alert-${type}`);
    alertEl.innerText = message;
    alertEl.classList.add('show');
    alertTimeout = setTimeout(() => {
        alertEl.classList.remove('show');
    }, duration);
}

function updateCoinIcon(coinCode) {
    const coin = CRYPTO_COINS.find(c => c.code === coinCode) || CRYPTO_COINS[0];
    document.getElementById('coinIcon').className = coin.icon;
}

// Kripto Para Dropdown'unu Doldurma
function populateCoinDropdown(selectedCoin) {
    const dropdown = document.getElementById('coinSelect');
    dropdown.innerHTML = '';
    CRYPTO_COINS.forEach(coin => {
        const option = document.createElement('option');
        option.value = coin.code;
        option.innerText = coin.name;
        dropdown.appendChild(option);
    });
    dropdown.value = selectedCoin;
    updateCoinIcon(selectedCoin);
}

// HÄ±z SeÃ§imi ve Aktivasyon AlanÄ±nÄ± Doldurma
function populateSpeedOptions(appState) {
    const container = document.getElementById('speedOptionsContainer');
    container.innerHTML = '';

    const unlockedSpeeds = appState.unlockedSpeeds || {};

    SPEED_LEVELS.forEach(level => {
        const speed = level.speed;
        let isActivated = false;
        let remainingDays = 'SÃ¼resiz';

        if (speed === 3) {
            isActivated = true; // 3x her zaman aÃ§Ä±ktÄ±r
        } else if (unlockedSpeeds[speed]) {
            const expiryTime = unlockedSpeeds[speed];
            const remainingMs = expiryTime - Date.now();

            if (remainingMs > 0) {
                isActivated = true;
                remainingDays = Math.ceil(remainingMs / (1000 * 60 * 60 * 24)) + " GÃ¼n KaldÄ±";
            } else {
                // SÃ¼re dolduysa, sadece kayÄ±ttan silinmez, ama artÄ±k kullanÄ±lamaz.
                isActivated = false;
            }
        }
        
        const isCurrentSpeed = appState.fanSpeed === speed;

        const optionDiv = document.createElement('div');
        optionDiv.classList.add('speed-option');
        
        const details = `
            <div class="speed-details">
                <span class="speed-name" style="color: ${isCurrentSpeed ? '#4cd964' : '#00BFFF'};">
                    ${level.label} ${isCurrentSpeed ? ' (AKTÄ°F)' : ''}
                </span>
                <span class="speed-duration" style="color: ${isActivated ? '#4cd964' : '#FF0057'};">
                    ${isActivated ? remainingDays : 'Kilitli'}
                </span>
            </div>
            <div class="speed-controls">
                ${speed === 3 ? `
                    <button class="${isCurrentSpeed ? 'btn-activate' : 'btn-disabled'}" onclick="window.handleSpeedChange(${speed})" ${isCurrentSpeed ? 'disabled' : ''}>
                        SEÃ‡
                    </button>
                ` : isActivated ? `
                    <button class="${isCurrentSpeed ? 'btn-activate' : 'btn-buy'}" onclick="window.handleSpeedChange(${speed})" ${isCurrentSpeed ? 'disabled' : ''}>
                        SEÃ‡
                    </button>
                ` : `
                    <input type="text" id="keyInput-${speed}" placeholder="Key GiriÅŸi" maxlength="15">
                    <button class="btn-activate" onclick="window.activateSpeed(${speed})">
                        Key Aktif
                    </button>
                    <button class="btn-buy" onclick="window.buySpeed(${speed})">
                        SatÄ±n Al
                    </button>
                `}
            </div>
        `;
        optionDiv.innerHTML = details;
        container.appendChild(optionDiv);
    });
}


// UI'Ä± mevcut duruma gÃ¶re gÃ¼ncelleyen ana fonksiyon
function updateUI(appState) {
    if (!appState) return;
    
    // HÄ±z ve Bakiye Bilgileri
    document.getElementById('miningBalance').innerHTML = `${appState.miningBalance.toFixed(6)} <span>${appState.selectedCoin}</span>`;
    document.getElementById('speedMultiplier').innerText = `Aktif HÄ±z: ${appState.fanSpeed}x`;
    document.getElementById('currentHashrate').innerText = `${calculateHashrate(appState.fanSpeed)} MH/s`;
    
    // Fan ve Buton Durumu
    const btn = document.getElementById('toggleMiningBtn');
    const fan = document.getElementById('fanContainer');

    if (appState.isMining) {
        btn.classList.remove('mining-off');
        btn.classList.add('mining-on');
        btn.innerHTML = '<i class="fas fa-pause"></i> KAZIMI DURDUR';
        fan.classList.add('spinning');
        document.getElementById('miningTimer').style.color = '#4cd964';
    } else {
        btn.classList.remove('mining-on');
        btn.classList.add('mining-off');
        btn.innerHTML = '<i class="fas fa-play"></i> LONG KAZIMI BAÅLAT';
        fan.classList.remove('spinning');
        document.getElementById('miningTimer').style.color = '#FF0057';
    }

    // Transfer Butonu Durumu
    document.getElementById('transferBtn').disabled = appState.miningBalance < 0.000001 || appState.isMining;
    
    // HÄ±z alanÄ±nÄ± gÃ¼ncelleyerek kilit/seÃ§ili durumu yansÄ±t
    populateSpeedOptions(appState); 
}

// SÃ¼re SayacÄ±
function startTimer(startTimeMs, isMining) {
    clearInterval(timerInterval);
    const timerEl = document.getElementById('miningTimer');
    const infoEl = document.getElementById('lastTransferInfo');

    if (!isMining) {
        timerEl.innerText = "00:00:00";
        infoEl.innerText = "Madencilik baÅŸlamadÄ±. BaÅŸlat dÃ¼ÄŸmesine basÄ±n.";
        return;
    }

    timerInterval = setInterval(() => {
        const elapsedTimeMs = Date.now() - startTimeMs;
        const remainingTimeMs = TWELVE_HOURS - (elapsedTimeMs % TWELVE_HOURS); 

        const totalHours = Math.floor(remainingTimeMs / (1000 * 60 * 60));
        const totalMinutes = Math.floor((remainingTimeMs % (1000 * 60 * 60)) / (1000 * 60));
        const totalSeconds = Math.floor((remainingTimeMs % (1000 * 60)) / 1000);

        const hours = String(totalHours).padStart(2, '0');
        const minutes = String(totalMinutes).padStart(2, '0');
        const seconds = String(totalSeconds).padStart(2, '0');

        timerEl.innerText = `${hours}:${minutes}:${seconds}`;
        infoEl.innerText = `Kalan SÃ¼re: ${hours} saat ${minutes} dakika`;

        // 12 saatlik dÃ¶ngÃ¼ biterse
        if (remainingTimeMs < 1000 && remainingTimeMs > -1000) {
            // DÃ¶ngÃ¼ otomatik olarak madencilik akÄ±ÅŸÄ±nÄ± tetikler ve transferi yapar.
            timerEl.innerText = "TRANSFER OTO YAPILIYOR..."; 
        }
    }, 1000);
}


// =========================================================================
// --- FIREBASE VERÄ° Ä°ÅLEMLERÄ° ---
// =========================================================================

async function getAppState() {
    if (!currentUserID) return null;

    try {
        const userDocRef = docRef(db, "users", currentUserID);
        const docSnap = await getDoc(userDocRef);

        const defaultState = {
            isMining: false, miningBalance: 0.0, fanSpeed: 3, 
            selectedCoin: 'USDT', miningStartTime: 0, 
            mainBalance: { USDT: 0.0 }, // BaÅŸlangÄ±Ã§ta sadece USDT
            unlockedSpeeds: { 3: 9999999999999 }, // 3x sÃ¼resiz aÃ§Ä±k (unix timestamp Ã§ok bÃ¼yÃ¼k)
        };

        if (docSnap.exists()) {
            let appState = { ...defaultState, ...docSnap.data() };
            
            // HÄ±z sÃ¼releri dolanlarÄ± kontrol et
            if (appState.unlockedSpeeds) {
                Object.keys(appState.unlockedSpeeds).forEach(speed => {
                    const expiry = appState.unlockedSpeeds[speed];
                    if (expiry < Date.now()) {
                        delete appState.unlockedSpeeds[speed];
                        if (appState.fanSpeed === parseInt(speed)) {
                            appState.fanSpeed = 3; // SÃ¼re dolduysa 3x'e dÃ¼ÅŸÃ¼r
                        }
                    }
                });
            }

            // EÄŸer fanSpeed artÄ±k kilitliyse 3x'e geri dÃ¶n
            if (!appState.unlockedSpeeds || !appState.unlockedSpeeds[appState.fanSpeed]) {
                appState.fanSpeed = 3;
            }

            return appState;
        } else {
            await setDoc(userDocRef, defaultState);
            return defaultState;
        }
    } catch (e) {
        console.error("Firestore'dan veri Ã§ekme hatasÄ±:", e);
        showFloatingAlert("Veri hatasÄ±: Sunucu baÄŸlantÄ± sorunu.", 'error');
        return null;
    }
}

// Bakiye ve Madencilik SimÃ¼lasyonu
function updateMiningBalanceAndCheckTransfer(appState) {
    const now = Date.now();
    const elapsedTimeMs = now - appState.lastUpdateTime;
    const timeElapsedHours = elapsedTimeMs / (1000 * 60 * 60); 
    let updates = {};
    
    // 1. KazÄ±m SimÃ¼lasyonu
    if (appState.isMining && timeElapsedHours > 0) {
        const dailyRate = getDailyRate(appState.fanSpeed); 
        const earnings = dailyRate * timeElapsedHours / 24;
        const randomness = (Math.random() * 0.4) + 0.8; 
        const finalEarnings = earnings * randomness;

        appState.miningBalance = parseFloat((appState.miningBalance + finalEarnings).toFixed(6));
        appState.lastUpdateTime = now; 
        updates.miningBalance = appState.miningBalance;
        updates.lastUpdateTime = appState.lastUpdateTime;
    }
    
    // 2. Otomatik Transfer KontrolÃ¼ (12 saatlik dÃ¶ngÃ¼ kontrolÃ¼)
    if (appState.isMining && (now - appState.miningStartTime) >= TWELVE_HOURS) {
        appState = performTransfer(appState, true);
        
        // Yeni dÃ¶ngÃ¼yÃ¼ baÅŸlat
        appState.miningStartTime = now; 
        
        updates.miningBalance = appState.miningBalance;
        updates.miningStartTime = appState.miningStartTime;
        updates.mainBalance = appState.mainBalance; 

        // Transferi takiben timer'Ä± sÄ±fÄ±rla
        startTimer(appState.miningStartTime, true); 
    }
    
    if (Object.keys(updates).length > 0) {
       saveAppState(updates); 
    }
    
    return appState;
}


// =========================================================================
// --- KULLANICI ETKÄ°LEÅÄ°MÄ° (WINDOW FUNCTIONS) ---
// =========================================================================

// HÄ±zÄ± Key ile AktifleÅŸtirme
window.activateSpeed = async function(speed) {
    const keyInput = document.getElementById(`keyInput-${speed}`).value.trim().toUpperCase();
    const keyData = Object.entries(ACTIVATION_KEYS).find(([key, data]) => data.speed === speed && key === keyInput);

    if (!keyData) {
        showFloatingAlert("YanlÄ±ÅŸ Key! LÃ¼tfen anahtarÄ±nÄ±zÄ± kontrol edin.", 'error');
        return;
    }
    
    const [key, data] = keyData;
    let appState = await getAppState();
    
    const expiryTime = Date.now() + data.duration;

    // HÄ±zÄ± aÃ§
    appState.unlockedSpeeds[speed] = expiryTime;
    
    // Otomatik olarak yeni hÄ±zÄ± seÃ§
    appState.fanSpeed = speed;
    
    await saveAppState({ 
        unlockedSpeeds: appState.unlockedSpeeds, 
        fanSpeed: appState.fanSpeed 
    });
    
    // UI'Ä± gÃ¼ncelleyip kullanÄ±cÄ±yÄ± bilgilendir
    populateSpeedOptions(appState);
    updateUI(appState); 
    showFloatingAlert(`ğŸš€ BaÅŸarÄ±lÄ±! ${speed}x HÄ±z ${data.duration / (1000 * 60 * 60 * 24)} GÃ¼nlÃ¼ÄŸÃ¼ne Aktif Edildi.`, 'success', 6000);
}

// HÄ±zÄ± SatÄ±n Alma (YÃ¶nlendirme)
window.buySpeed = function(speed) {
    showFloatingAlert(`Ã–deme sayfasÄ±na yÃ¶nlendiriliyorsunuz...`, 'info');
    // GerÃ§ekte Ã¶deme butonuna basÄ±nca gideceÄŸi sayfa
    window.location.href = `odeme.html?speed=${speed}`; 
}

// Kripto Para SeÃ§imini GÃ¼ncelleme
window.updateCoinSelection = async function() {
    const selectedCoin = document.getElementById('coinSelect').value;
    let appState = await getAppState();
    
    appState.selectedCoin = selectedCoin;
    await saveAppState({ selectedCoin: appState.selectedCoin });
    
    updateCoinIcon(selectedCoin);
    updateUI(appState);
    showFloatingAlert(`KazÄ±m ParasÄ± ${selectedCoin} olarak ayarlandÄ±.`, 'info', 1500);
}

// HÄ±z SeÃ§imini GÃ¼ncelleme
window.handleSpeedChange = async function(speed) {
    let appState = await getAppState();
    if (!appState) return;

    // EÄŸer kilitli deÄŸilse (3x sÃ¼resiz, diÄŸerleri sÃ¼re bitmemiÅŸse)
    if (appState.unlockedSpeeds[speed]) {
        appState.fanSpeed = speed;
        await saveAppState({ fanSpeed: appState.fanSpeed });
        updateUI(appState);
        showFloatingAlert(`${speed}x HÄ±z SeÃ§ildi.`, 'info', 1500);
    } else {
        showFloatingAlert("Bu hÄ±zÄ±n sÃ¼resi doldu veya aktif deÄŸil.", 'error');
    }
}

// KazÄ±mÄ± BaÅŸlat/Durdur
window.toggleMining = async function() {
    let appState = await getAppState();
    if (!appState) return;

    appState.isMining = !appState.isMining;
    appState.lastUpdateTime = Date.now(); 
    
    if (appState.isMining) {
        // Yeni dÃ¶ngÃ¼ baÅŸlangÄ±Ã§ zamanÄ±nÄ± kaydet
        appState.miningStartTime = Date.now(); 
        
        showFloatingAlert(`KazÄ±m ${appState.fanSpeed}x hÄ±z ile baÅŸlatÄ±ldÄ±!`, 'success');
        startMiningLoop();
        startTimer(appState.miningStartTime, true);
    } else {
        showFloatingAlert('KazÄ±m durduruldu.', 'error');
        clearInterval(miningInterval);
        clearInterval(timerInterval);
        startTimer(0, false); // Timer'Ä± sÄ±fÄ±rla
    }
    
    await saveAppState({ 
        isMining: appState.isMining, 
        lastUpdateTime: appState.lastUpdateTime,
        miningStartTime: appState.miningStartTime
    });
    updateUI(appState);
}

// Manuel Transfer (Sadece madencilik kapalÄ±yken)
window.transferMiningBalance = async function() {
    let appState = await getAppState();
    if (!appState || appState.miningBalance < 0.000001) {
        showFloatingAlert("AktarÄ±lacak bakiye 0'a yakÄ±n.", 'error');
        return;
    }
    if (appState.isMining) {
        showFloatingAlert("Transfer yapmadan Ã¶nce madenciliÄŸi durdurun.", 'error');
        return;
    }

    appState = performTransfer(appState, false);
    
    await saveAppState({ 
        miningBalance: appState.miningBalance, 
        mainBalance: appState.mainBalance
    });
    
    updateUI(appState); 
}


// =========================================================================
// --- BAÅLANGIÃ‡ ---
// =========================================================================

async function init() {
    let appState = await getAppState();
    if (!appState) return;

    // TÃ¼m UI elemanlarÄ±nÄ± yÃ¼klenen veriye gÃ¶re doldur
    populateCoinDropdown(appState.selectedCoin || 'USDT');
    populateSpeedOptions(appState);
    
    // Madencilik akÄ±ÅŸÄ±nÄ± ve transfer kontrolÃ¼nÃ¼ tetikle
    appState = updateMiningBalanceAndCheckTransfer(appState); 
    updateUI(appState); 

    // Timer'Ä± ve madencilik dÃ¶ngÃ¼sÃ¼nÃ¼ baÅŸlat
    if (appState.isMining) {
        startMiningLoop();
        startTimer(appState.miningStartTime, true);
    } else {
        startTimer(0, false);
    }
    
    showFloatingAlert("Veriler baÅŸarÄ±yla yÃ¼klendi. Long KazÄ±m'a baÅŸlayabilirsiniz.", 'success', 3000);
}


onAuthStateChanged(auth, (user) => {
    if (user && user.emailVerified) {
        currentUserID = user.uid;
        init(); 
    } else {
        // GeliÅŸtirme/Demo modu iÃ§in, kullanÄ±cÄ± ID'si yoksa
        // **GerÃ§ek uygulamada burayÄ± giriÅŸ sayfasÄ±na yÃ¶nlendirmelisiniz.**
        // window.location.href = "index.html"; 
        currentUserID = "demo_user_123";
        init(); // Demo kullanÄ±cÄ± ile devam et
        document.getElementById('lastTransferInfo').innerText = "DEMO MODU: GerÃ§ek veri iÃ§in giriÅŸ yapÄ±n.";
        showFloatingAlert("GiriÅŸ yapÄ±lmadÄ±ÄŸÄ± iÃ§in Demo Modu aktif.", 'error', 5000);
    }
});
</script>
  
</body>
</html>
